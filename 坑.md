### ezbuy前车之鉴

#### 网络请求在生命周期中一定要Cancel
	
* 这个问题就不用说了，反正就是当异步请求的时候，Activity或者Fragment的销毁的时候请务必一定要cancle掉请求；

* 如果没有的话，当数据返回后，依然持有Context或者改变视图的时候就会出现nullPoint，因为这个视图已经被销毁了，不再存在了；

* 我们的bug中有很多一部分是都是出于这个原因；

* 请务必一定要在onDestroy或者onStop中调用RpcRequest.cancle();请务必一定要在onDestroy或者onStop中调用RpcRequest.cancle();请务必一定要在onDestroy或者onStop中调用RpcRequest.cancle();

#### adapter中的需要注意的

* 问题出现场景：
	
	* 在ezbuy app中home primeHome mine中都是通过RecyclerView的多type进行的区分复杂的不规则Item的；

	* 如果在一个Type中开启多个线程刷新数据就会存在多次刷新，闪动的问题，一闪一闪亮晶晶，一点都不可爱；

* 解决办法：
	
	* 如果视图很复杂就多区分几个type；

	* 一个type中尽量只有一个线程请求数据并刷新；

	* 当Item Type对应的数据返回，请不要盲目调用 adapter.notifyDataSetChanged()数据，请优先使用 adapter.notifyItemMoved(fromPosition, toPosition)局部刷新;

	* RecyclerView刷新数据会自带默认16ms左右的动画，可以通过` ((SimpleItemAnimator) recyclerView.getItemAnimator()).setSupportsChangeAnimations(false);`这个方法去除动画；

#### 汇率不能获取

* 问题出现的场景：
	
	* 当网络特别特别特别慢的时候我们，就有可能出现汇率没有请求返回的状况；

	* 因为涉及到汇率运算也不能简单返回0，也不能单纯的保存在本地；

* 暂时解决办法：
	
	* 存两份

		* 内存中：app启动时实施获取；

		* sp中：如果在内存中获取失败就会在sp中取，sp是每次存入内存时候更新，保证时效性，备用；

		* 这样就能保证不会因取不到汇率而算错，崩溃；


#### 电话号码的小问题

* 问题所在：

	* 电话号码的格式正则式`^(66)(0?[1-9]\d{5,13})$` 可以区分为+CallingCode CaptureGroup2 也就是有2个group；

	* 解析的时候就需要每一个Group通过类似指针的方式解析，一旦不符合格式就会在指针所在的group为nullPoint了;

	* 这个问题理论上是不会出现的，但是前提是当服务器返回的电话号码格式绝对正确，但是......，偶尔也会有那么几个电话是不符合格式的；

	* 夸奖下毕老师，这里的电话号码的View蛮健壮的，点赞 +10086；

* 解决方法：

```java
	try{

	//解析电话号码格式

	}catch(NullPointException e){

	//返回不符合格式的电话号码

	}；
```

#### RecyclerView中加入GridView是隐形炸弹

* 出现的历史原因：

	* 这个问题出现在ezbuy app中的mine页面的Ui上（MineFragment）中，因为莫名需求“要在mine的下面加上 U May Like 的商品列表”，美其名曰“淘宝就有这个”，但是万万没想到的是：后来因为没有收集到可靠的用户行为就砍掉了这个需求；

	* 但是作为一个健壮的程序猿写出的代码也要有健壮性，保不准那一天就会要求添加上这一功能（因为X宝有，所以我们必不可少嘛）；

	* 再者就是在mine页面有一个类似九宫格的动态的添加块格状的布局；

* 第一个失败的方案：

	* 综合以上的需求我就制订了一个从理论上和实践上都可行的方案：Mine页面最外层用一个RecycleView,通过多个Type来区分不同的复杂Item;

	* 其中最关键的点就是：在九宫格视图中用到了GridView，用来保证可以随时随地随心所欲的添加空格；（这恰恰就是问题的根源所在），从理论上这是没有任何问题的；

* 问题所在之处：

	* 当RecyclerView中嵌套GridView时候就出现比较灵异的事件；在部分系统中会抛出这样一个Exception` java.lang.ClassCastException: android.widget.AbsListView$LayoutParams cannot be cast  to android.widget.GridlView$LayoutParams`;让我泪崩的就是当我查看SDK的api时候发现GridView就是继承自AbsListView；因此这个问题也只是出现在部分机型中，尤其是被深度定制的系统中；例如神米，锤子爸爸手机系统中。。。。。也就是说理论上是没有任何问题的方案，愣是被一头雾水的搞崩溃了，于是我就定义为这是一个兼容性问题；

	* 可滑动视图的嵌套出现的冲突问题，这个问题比较容易解决，根据经验只需要重写子视图的onMeasure的方法，调整高度即可；
```java
 		@Override
        protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
        int expandSpec = MeasureSpec.makeMeasureSpec(Integer.MAX_VALUE >> 2,
        MeasureSpec.AT_MOST);
        super.onMeasure(widthMeasureSpec, expandSpec);
    }
```

	

* 解决办法：
	
	* 第一个方案（不推荐）：因为这个问题是发布第二天发现的：所以紧急发一个一个版本，就采用“愚蠢”的方法一个一个添加的TextViw，这样就很不灵活，不健壮，没情怀；

	* 第二个方案；将GridViw替换为RecyclerView,也就是RecycleVIew中嵌入RecyclerView，这样就避免了以上的所有问题，当然也很健壮啦；

* 总结：

	* 千万不要用RecyclerView中嵌套GridView（ListView没试过，估计也不会好到哪里去）；

	* 不要过多的嵌套，能够避免就不要用嵌套，因为说不振就会出现预料之外的兼容性问题以及滑动点击冲突等一系列问题；